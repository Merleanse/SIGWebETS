<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebGIS Jaringan Jalan dan Kepadatan Penduduk - Jakarta</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
      body {
        margin: 0; padding: 0; font-family: Arial, sans-serif;
      }
      #map {
        width: 100%; height: 100vh;
      }
      .legend {
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        line-height: 1.5;
      }
      .legend h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 16px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 5px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
        font-size: 13px;
      }
      .legend-item i {
        width: 20px;
        height: 20px;
        display: inline-block;
        margin-right: 8px;
        opacity: 0.8;
        border: 1px solid #ccc;
      }
      .legend-item i.line {
        height: 4px;
        border: none;
      }
      /* Style untuk Fitur Baru */
      .filter-container {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.65);
      }
      .filter-container select {
        padding: 5px;
        border-radius: 3px;
        border: 1px solid #ccc;
        width: 200px;
      }
      .info-coordinates {
        background: rgba(255, 255, 255, 0.8);
        padding: 5px 10px;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.65);
        font-size: 12px;
      }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Elemen HTML untuk Dropdown Filter -->
    <div class="filter-container">
        <label for="kecamatan-filter" style="font-size: 14px; display: block; margin-bottom: 5px;">Pilih Kecamatan:</label>
        <select id="kecamatan-filter">
            <option value="">Tampilkan Semua</option>
        </select>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>

      // PENGATURAN AWAL
      const initialCoords = [-6.27, 106.85]; // Pusat antara Jaktim & Jaksel
      const initialZoom = 12;
      var map = L.map("map").setView(initialCoords, initialZoom);

      // BASEMAPS
      var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors", maxZoom: 19,
      });
      var satellite = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
        attribution: "Tiles Â© Esri", maxZoom: 19,
      });
      // PERUBAHAN: Basemap ketiga diubah menjadi Carto Light
      var lightMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
      });
      osm.addTo(map);

      // FUNGSI BANTU
      function getColorDensity(d) {
        return d > 23000 ? '#800026' :
               d > 19000 ? '#BD0026' :
               d > 15000 ? '#E31A1C' :
               d > 12000 ? '#FC4E2A' :
                           '#FFEDA0';
      }

      function getRoadStyle(remark) {
        if (remark.includes("Arteri")) return { color: "#e74c3c", weight: 4 };
        if (remark.includes("Kolektor")) return { color: "#f39c12", weight: 3 };
        if (remark.includes("Lokal")) return { color: "#3498db", weight: 2 };
        if (remark.includes("Tol")) return { color: "#9b59b6", weight: 5 };
        if (remark.includes("Setapak")) return { color: "#7f8c8d", weight: 1, dashArray: '5, 5' };
        return { color: "#95a5a6", weight: 1 };
      }

      let layers = {};
      let kecamatanLayers = {}; // Objek untuk menyimpan referensi layer kecamatan



      const filesToLoad = {
          penduduk: "data/geojson_jaks/AreaAdministrasi.geojson",
          arteri: "data/geojson_jaks/Arteri.geojson",
          kolektor: "data/geojson_jaks/Kolektor.geojson",
          lokal: "data/geojson_jaks/Lokal.geojson",
          lain: "data/geojson_jaks/Lain.geojson",
          setapak: "data/geojson_jaks/Setapak.geojson",
          tolDPF: "data/geojson_jaks/TolDPF.geojson",
          tolLayang: "data/geojson_jaks/TolLayang.geojson",
          tolTPF: "data/geojson_jaks/TolTPF.geojson"
      };

      const promises = Object.values(filesToLoad).map(url => 
        fetch(url).then(response => {
            if (!response.ok) throw new Error(`Gagal memuat: ${url} (${response.statusText})`);
            return response.json();
        })
      );

      Promise.all(promises)
        .then(results => {
            const [
                dataPenduduk, dataArteri, dataKolektor, dataLokal,
                dataLain, dataSetapak, dataTolDPF, dataTolLayang, dataTolTPF
            ] = results;

            // --- 1. PROSES DATA KEPENDUDUKAN ---
            layers.penduduk = L.geoJSON(dataPenduduk, {
                style: feature => ({
                    fillColor: getColorDensity(feature.properties.KPDT_PDD),
                    weight: 2, opacity: 1, color: "white", fillOpacity: 0.7,
                }),
                onEachFeature: (feature, layer) => {
                    const props = feature.properties;
                    const kecamatanName = props.NAMOBJ;

                    if (kecamatanName) {
                        kecamatanLayers[kecamatanName] = layer;
                    }

                    const popupContent = `
                        <div style="min-width: 250px; font-family: Arial;">
                            <h3 style="margin: 0 0 10px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px;">
                                Kec. ${kecamatanName || 'N/A'} 
                            </h3>
                            <table style="width: 100%; font-size: 13px;">
                                <tr><td><strong>Jml. Penduduk</strong></td><td><strong>${(props.JML_PDD || 0).toLocaleString("id-ID")}</strong> jiwa</td></tr>
                                <tr><td><strong>Luas</strong></td><td>${(props.LUASAREAKM || 0).toFixed(2)} kmÂ²</td></tr>
                                <tr><td><strong>Kepadatan</strong></td><td><strong>${(props.KPDT_PDD || 0).toLocaleString("id-ID")}</strong> jiwa/kmÂ²</td></tr>
                                <tr><td><strong>Klasifikasi</strong></td><td>${props.klas_jml || 'N/A'}</td></tr>
                            </table>
                        </div>`;
                    layer.bindPopup(popupContent);
                    layer.bindTooltip(`Kec. ${kecamatanName || 'N/A'}`);
                    layer.on({
                        mouseover: e => e.target.setStyle({ weight: 4, color: "#666", fillOpacity: 0.9 }),
                        mouseout: e => layers.penduduk.resetStyle(e.target)
                    });
                }
            }).addTo(map);

            // --- 2. PROSES DATA JARINGAN JALAN ---
            const createRoadLayer = (data) => L.geoJSON(data, {
                style: feature => getRoadStyle(feature.properties.REMARK || ""),
                onEachFeature: (feature, layer) => {
                    layer.bindPopup(`<strong>Jenis:</strong> ${feature.properties.REMARK || "Tidak ada data"}`);
                }
            });

            layers.jalanArteri = createRoadLayer(dataArteri);
            layers.jalanKolektor = createRoadLayer(dataKolektor);
            layers.jalanLokal = createRoadLayer(dataLokal);
            layers.jalanLainnya = L.layerGroup([createRoadLayer(dataLain), createRoadLayer(dataSetapak)]);
            layers.jalanTol = L.layerGroup([createRoadLayer(dataTolDPF), createRoadLayer(dataTolLayang), createRoadLayer(dataTolTPF)]);

            setupControls();
            populateFilter(Object.keys(kecamatanLayers).sort());
            console.log("Semua layer berhasil dimuat dan peta siap digunakan!");
        })
        .catch(error => {
            console.error("Terjadi kesalahan saat memuat data GeoJSON:", error);
            alert("Gagal memuat satu atau lebih file data. Pastikan semua file .geojson berada di folder yang sama dengan file .html ini dan periksa console (F12) untuk detail error.");
        });


      function populateFilter(kecamatanNames) {
        const filterSelect = document.getElementById('kecamatan-filter');
        kecamatanNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            filterSelect.appendChild(option);
        });

        filterSelect.addEventListener('change', (e) => {
            const selectedKecamatan = e.target.value;
            if (selectedKecamatan && kecamatanLayers[selectedKecamatan]) {
                const layer = kecamatanLayers[selectedKecamatan];
                map.fitBounds(layer.getBounds());
                layer.openPopup();
            } else {
                map.setView(initialCoords, initialZoom);
            }
        });
      }


      function setupControls() {
        // --- LAYER CONTROL ---
        const baseMaps = { 
            "OpenStreetMap": osm, 
            "Satellite Imagery": satellite,
            "Carto Light": lightMap 
        };
        const overlayMaps = {
          "ðŸ‘¥ Kepadatan Penduduk": layers.penduduk,
          "<hr><b>Jaringan Jalan:</b>": L.layerGroup(),
          "ðŸ›£ï¸ Jalan Arteri": layers.jalanArteri,
          "ðŸš— Jalan Kolektor": layers.jalanKolektor,
          "ðŸ  Jalan Lokal": layers.jalanLokal,
          "é«˜é€Ÿ Jalan Tol": layers.jalanTol,
          "ðŸš¶ Jalan Lain & Setapak": layers.jalanLainnya
        };
        L.control.layers(baseMaps, overlayMaps, { position: "topleft", collapsed: false }).addTo(map);

        // --- SCALE ---
        L.control.scale({ position: "bottomleft", imperial: false }).addTo(map);
        
        // --- KOORDINAT POINTER ---
        const coordinatesControl = L.control({ position: 'bottomleft' });
        coordinatesControl.onAdd = function(map) {
            this._div = L.DomUtil.create('div', 'info-coordinates');
            this.update();
            return this._div;
        };
        coordinatesControl.update = function(latlng) {
            const text = latlng ? `Lat: ${latlng.lat.toFixed(5)}, Lng: ${latlng.lng.toFixed(5)}` : 'Gerakkan mouse di atas peta';
            this._div.innerHTML = text;
        };
        coordinatesControl.addTo(map);

        map.on('mousemove', e => coordinatesControl.update(e.latlng));
        map.on('mouseout', () => coordinatesControl.update());

        // --- LEGENDA ---
        const legendPenduduk = L.control({ position: "bottomright" });
        legendPenduduk.onAdd = function () {
          const div = L.DomUtil.create("div", "legend");
          const grades = [0, 12000, 15000, 19000, 23000];
          div.innerHTML = "<h4>Kepadatan Penduduk<br>(jiwa/kmÂ²)</h4>";
          for (let i = 0; i < grades.length; i++) {
            div.innerHTML += `<div class="legend-item"><i style="background:${getColorDensity(grades[i] + 1)}"></i> ${grades[i].toLocaleString('id-ID')}${(grades[i+1] ? '&ndash;'+grades[i+1].toLocaleString('id-ID') : '+')}</div>`;
          }
          return div;
        };

        const legendJalan = L.control({ position: "bottomright" });
        legendJalan.onAdd = function () {
            const div = L.DomUtil.create("div", "legend");
            div.innerHTML = "<h4>Legenda Jalan</h4>";
            const roadTypes = [
                { remark: "Jalan Tol", label: "Jalan Tol" },
                { remark: "Jalan Arteri", label: "Jalan Arteri" },
                { remark: "Jalan Kolektor", label: "Jalan Kolektor" },
                { remark: "Jalan Lokal", label: "Jalan Lokal" }
            ];
            roadTypes.forEach(type => {
                const style = getRoadStyle(type.remark);
                div.innerHTML += `<div class="legend-item"><i class="line" style="background:${style.color}; height:${style.weight}px;"></i> ${type.label}</div>`;
            });
            return div;
        };

        legendPenduduk.addTo(map);

        // --- LOGIKA TAMPIL/SEMBUNYIKAN LEGEND ---
        map.on("overlayadd", e => {
          if (e.name.includes("Penduduk")) legendPenduduk.addTo(map);
          if (e.name.includes("Jalan")) legendJalan.addTo(map);
        });

        map.on("overlayremove", e => {
          if (e.name.includes("Penduduk")) legendPenduduk.remove();
          if (e.name.includes("Jalan")) {
              const anyJalanLayerActive = Object.keys(overlayMaps).some(key => 
                  key.includes("Jalan") && map.hasLayer(overlayMaps[key])
              );
              if (!anyJalanLayerActive) legendJalan.remove();
          }
        });

        // --- TOMBOL ZOOM HOME ---
        L.Control.ZoomHome = L.Control.extend({
          options: { position: "topleft" },
          onAdd: function (map) {
            const container = L.DomUtil.create("div", "leaflet-bar leaflet-control");
            const button = L.DomUtil.create("a", "", container);
            button.innerHTML = "ðŸ ";
            button.href = "#";
            button.title = "Zoom ke Tampilan Awal"; 
            button.style.cssText = "font-size: 18px; width: 30px; height: 30px; line-height: 30px; text-align: center; text-decoration: none; color: #000;";
            L.DomEvent.on(button, "click", e => {
              L.DomEvent.preventDefault(e);
              map.setView(initialCoords, initialZoom);
            });
            return container;
          },
        });
        new L.Control.ZoomHome().addTo(map);
      }
    </script>
</body>
</html>